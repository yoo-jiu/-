import streamlit as st
import pandas as pd
import plotly.graph_objects as go
import plotly.express as px
from io import StringIO
import importlib

# Streamlit Cloud JS ìºì‹œ ì˜¤ë¥˜ ë°©ì§€
importlib.invalidate_caches()

st.set_page_config(layout="wide")
st.title("ğŸ“Œ ë°˜ë ¤ë™ë¬¼ ë“±ë¡ ë°ì´í„° ë¶„ì„ ëŒ€ì‹œë³´ë“œ (CSV ì—†ì´ ìë™ ë¡œë“œ)")

# -------------------------------------------------------
# 1) CSV ë‚´ìš©ì„ ì½”ë“œ ë‚´ë¶€ì— ì§ì ‘ í¬í•¨
# -------------------------------------------------------

csv_data = """
ë…„ë„,ìë©´ë™(ë²•ì •ë™),ë“±ë¡ì£¼ì²´(ì‹œêµ°êµ¬),ë“±ë¡ì£¼ì²´(ëŒ€í–‰ì—…ì²´),ë“±ë¡ì£¼ì²´(ê¸°íƒ€(ì´ë²¤íŠ¸ë“±)),RFIDì¢…ë¥˜(ë‚´ì¥í˜•),RFIDì¢…ë¥˜(ì™¸ì¥í˜•),RFIDì¢…ë¥˜(ì¸ì‹í‘œ)
2024,ì‚¼ì„±ë™,120,55,8,140,30,12
2024,ëŒ€ì¹˜ë™,110,40,12,130,35,20
2024,ì ì‹¤ë³¸ë™,98,62,9,120,44,15
2024,ê°œí¬ë™,150,75,10,160,60,25
2024,ë…¼í˜„ë™,80,30,5,90,25,18
2024,ì••êµ¬ì •ë™,60,22,4,70,20,12
2024,ì—­ì‚¼ë™,95,55,6,110,40,18
2024,ì²­ë‹´ë™,130,78,12,150,55,22
2023,ì‚¼ì„±ë™,100,50,10,120,30,10
2023,ëŒ€ì¹˜ë™,90,45,9,110,28,14
2023,ì ì‹¤ë³¸ë™,88,55,8,105,40,12
2023,ê°œí¬ë™,140,70,9,150,55,20
2023,ë…¼í˜„ë™,75,32,6,88,28,14
2023,ì••êµ¬ì •ë™,58,20,4,72,22,11
2023,ì—­ì‚¼ë™,90,48,6,108,42,16
2023,ì²­ë‹´ë™,120,70,11,135,52,19
"""

df = pd.read_csv(StringIO(csv_data))

# -------------------------------------------------------
# 2) ë…„ë„ ì„ íƒ
# -------------------------------------------------------
years = sorted(df["ë…„ë„"].unique())
selected_year = st.selectbox("ğŸ“… ë…„ë„ë¥¼ ì„ íƒí•˜ì„¸ìš”", years)

df_year = df[df["ë…„ë„"] == selected_year].copy()

# -------------------------------------------------------
# 3) ë“±ë¡ì£¼ì²´ + RFID í•©ì‚°
# -------------------------------------------------------
sum_cols = [
    "ë“±ë¡ì£¼ì²´(ì‹œêµ°êµ¬)", "ë“±ë¡ì£¼ì²´(ëŒ€í–‰ì—…ì²´)", "ë“±ë¡ì£¼ì²´(ê¸°íƒ€(ì´ë²¤íŠ¸ë“±))",
    "RFIDì¢…ë¥˜(ë‚´ì¥í˜•)", "RFIDì¢…ë¥˜(ì™¸ì¥í˜•)", "RFIDì¢…ë¥˜(ì¸ì‹í‘œ)"
]

df_year["ì´í•©"] = df_year[sum_cols].sum(axis=1)

# -------------------------------------------------------
# 4) TOP10 ì„ ì •
# -------------------------------------------------------
df_top10 = df_year.sort_values("ì´í•©", ascending=False).head(10).reset_index(drop=True)

# -------------------------------------------------------
# 5) ìƒ‰ìƒ ìƒì„± (1ë“± ë¹¨ê°• + íŒŒë‘ ê·¸ë¼ë°ì´ì…˜)
# -------------------------------------------------------
colors = ["red"]
for i in range(1, len(df_top10)):
    shade = 255 - (i * 18)
    colors.append(f"rgb(0,0,{shade})")

# -------------------------------------------------------
# 6) Plotly ë§‰ëŒ€ê·¸ë˜í”„
# -------------------------------------------------------
fig = go.Figure()
fig.add_trace(go.Bar(
    x=df_top10["ìë©´ë™(ë²•ì •ë™)"],
    y=df_top10["ì´í•©"],
    marker=dict(color=colors)
))

fig.update_layout(
    title=f"ğŸ† {selected_year}ë…„ TOP10 ìë©´ë™ ë“±ë¡ ê±´ìˆ˜",
    xaxis_title="ìë©´ë™",
    yaxis_title="ì´ ë“±ë¡ ìˆ˜",
    template="plotly_white"
)

st.plotly_chart(fig, use_container_width=True)

# -------------------------------------------------------
# 7) ì§€ë„ í‘œì‹œ (ì„ì‹œ ì¢Œí‘œ ìƒì„±)
# -------------------------------------------------------
st.subheader("ğŸ“ TOP10 ìë©´ë™ ì§€ë„ ì‹œê°í™”")

df_top10["lat"] = 37.50 + (df_top10.index * 0.01)
df_top10["lon"] = 127.00 + (df_top10.index * 0.01)

map_fig = px.scatter_mapbox(
    df_top10,
    lat="lat",
    lon="lon",
    hover_name="ìë©´ë™(ë²•ì •ë™)",
    size="ì´í•©",
    zoom=11,
    height=500
)

map_fig.update_layout(mapbox_style="open-street-map")
st.plotly_chart(map_fig, use_container_width=True)
